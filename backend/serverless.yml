service: serverless-game-backend
# app and org for use with dashboard.serverless.com
app: serverless-game
org: silarsis

plugins:
  - serverless-pseudo-parameters
  - serverless-python-requirements

custom:
  pythonRequirements:
    pythonBin: python3
  defaultRegion: ap-southeast-1
  tables:
    entityName: 'entity-table-${self:provider.stage}'
    thingName: 'thing-table-${self:provider.stage}'
    locationName: 'location-table-${self:provider.stage}'
    landName: 'land-table-${self:provider.stage}'
    usersName: 'users-${self:provider.stage}'
    apiKeysName: 'api-keys-${self:provider.stage}'
    suggestionName: 'suggestion-${self:provider.stage}'
  topics:
    thingName: 'thing-topic-${self:provider.stage}'
  MessageDelayerName: 'message-delayer-${self:provider.stage}'

provider:
  name: aws
  runtime: python3.11
  memorySize: 128
  tracing:
    lambda: true
  region: ${opt:region, self:custom.defaultRegion}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource:
        - { "Fn::GetAtt": ["EntityDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["ThingDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["LocationDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["LandDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["UsersDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["ApiKeysDynamoDBTable", "Arn" ] }
        - { "Fn::GetAtt": ["SuggestionDynamoDBTable", "Arn" ] }
    - Effect: Allow
      Action:
        - states:StartExecution
      Resource:
        - !Ref MessageDelayer
    - Effect: Allow
      Action:
        - execute-api:ManageConnections
      Resource:
        - "arn:aws:execute-api:#{AWS::Region}:#{AWS::AccountId}:*/@connections/*"
  environment:
    ENTITY_TABLE: ${self:custom.tables.entityName}
    THING_TABLE: ${self:custom.tables.thingName}
    LOCATION_TABLE: ${self:custom.tables.locationName}
    LAND_TABLE: ${self:custom.tables.landName}
    THING_TOPIC_ARN: !Ref ThingTopic
    MESSAGE_DELAYER_ARN: !Ref MessageDelayer
    SUGGESTION_TABLE: ${self:custom.tables.suggestionName}
    DD_TRACE_AGENT_URL: 'https://ingest.lightstep.com:443'
    DD_TRACE_GLOBAL_TAGS: "lightstep.service_name:serverless-game,lightstep.access_token:${param:lightstep_access_token}"

functions:
  authLogin:
    handler: aspects/auth.auth_login
    environment:
      GOOGLE_CLIENT_ID: ${param:google_client_id, ''}
      USERS_TABLE: ${self:custom.tables.usersName}
      API_KEYS_TABLE: ${self:custom.tables.apiKeysName}
      JWT_SECRET: ${param:jwt_secret, 'dev-secret'}
    events:
      - http:
          path: /api/auth/login
          method: post
          cors: true
  authGenerateKey:
    handler: aspects/auth.auth_generate_key
    environment:
      API_KEYS_TABLE: ${self:custom.tables.apiKeysName}
      JWT_SECRET: ${param:jwt_secret, 'dev-secret'}
    events:
      - http:
          path: /api/auth/keys
          method: post
          cors: true
  authListKeys:
    handler: aspects/auth.auth_list_keys
    environment:
      API_KEYS_TABLE: ${self:custom.tables.apiKeysName}
      JWT_SECRET: ${param:jwt_secret, 'dev-secret'}
    events:
      - http:
          path: /api/auth/keys
          method: get
          cors: true
  authDeleteKey:
    handler: aspects/auth.auth_delete_key
    environment:
      API_KEYS_TABLE: ${self:custom.tables.apiKeysName}
      JWT_SECRET: ${param:jwt_secret, 'dev-secret'}
    events:
      - http:
          path: /api/auth/keys/{api_key}
          method: delete
          cors: true
  wsConnect:
    handler: aspects/websocket_handlers.connect_handler
    environment:
      JWT_SECRET: ${param:jwt_secret, 'dev-secret'}
    events:
      - websocket:
          route: $connect
  wsDisconnect:
    handler: aspects/websocket_handlers.disconnect_handler
    environment:
      THING_TABLE: ${self:custom.tables.thingName}
    events:
      - websocket:
          route: $disconnect
  wsDefault:
    handler: aspects/websocket_handlers.command_handler
    environment:
      THING_TABLE: ${self:custom.tables.thingName}
    events:
      - websocket:
          route: $default
  eventlogger:
    handler: aspects/eventLogger.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"

  location:
    handler: aspects/location.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Location

  land:
    handler: aspects/land.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Land

  landCreator:
    handler: aspects/landCreator.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - LandCreator

  communication:
    handler: aspects/communication.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Communication

  inventory:
    handler: aspects/inventory.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Inventory

  npc:
    handler: aspects/npc.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - NPC

  suggestion:
    handler: aspects/suggestion.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Suggestion

  equipment:
    handler: aspects/equipment.handler
    VpcId:
      Ref:
        Fn::ImportValue: VpcId
    package:
      exclude:
        - ./**
      include:
        - aspects/**
    events:
      - sns:
          arn: "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}"
          filterPolicy:
            aspect:
              - Equipment

resources:
  Resources:
    UsersDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: google_uid
            AttributeType: S
        KeySchema:
          - AttributeName: google_uid
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.usersName}
    ApiKeysDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: api_key
            AttributeType: S
          - AttributeName: google_uid
            AttributeType: S
        KeySchema:
          - AttributeName: api_key
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: "by-user"
            KeySchema:
              - AttributeName: google_uid
                KeyType: HASH
              - AttributeName: api_key
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.apiKeysName}
    ThingTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.topics.thingName}
    StepFunctionsServiceRole:
      Type: "AWS::IAM::Role"
      Properties:
        Path: "/#{AWS::StackName}/"
        ManagedPolicyArns:
          - "arn:aws:iam::aws:policy/AWSStepFunctionsFullAccess"
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            -
              Sid: "AllowStepFunctionsServiceToAssumeRole"
              Effect: "Allow"
              Action:
                - "sts:AssumeRole"
              Principal:
                Service: "states.#{AWS::Region}.amazonaws.com"
        Policies:
          - PolicyName: "PublishToSNSTopic"
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: "Allow"
                  Action:
                    - "sns:Publish"
                  Resource:
                    - !Ref ThingTopic
    MessageDelayer:
      Type: "AWS::StepFunctions::StateMachine"
      Properties:
        StateMachineName: ${self:custom.MessageDelayerName}
        RoleArn: !GetAtt StepFunctionsServiceRole.Arn
        # Replace "SecondsPath" with "TimestampPath" for scheduling
        DefinitionString: |
          {
            "StartAt": "Delay",
            "Comment": "Publish to SNS with delay",
            "States": {
              "Delay": {
                "Type": "Wait",
                "SecondsPath": "$.delay_seconds",
                "Next": "Publish to SNS"
              },
              "Publish to SNS": {
                "Type": "Task",
                "Resource": "arn:aws:states:::sns:publish",
                "Parameters": {
                  "TopicArn": "arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:custom.topics.thingName}",
                  "Message.$": "$.data",
                  "MessageAttributes": {
                    "aspect": {
                      "DataType": "String",
                      "StringValue.$": "$.data.aspect"
                    },
                    "action": {
                      "DataType": "String",
                      "StringValue.$": "$.data.action"
                    },
                    "uuid": {
                      "DataType": "String",
                      "StringValue.$": "$.data.uuid"
                    }
                  }
                },
                "End": true
              }
            }
          }

    EntityDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: uuid
            AttributeType: S
          - AttributeName: location
            AttributeType: S
          - AttributeName: connection_id
            AttributeType: S
        KeySchema:
          - AttributeName: uuid
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: "contents"
            KeySchema:
              - AttributeName: location
                KeyType: HASH
              - AttributeName: uuid
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
          - IndexName: "by_connection"
            KeySchema:
              - AttributeName: connection_id
                KeyType: HASH
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.entityName}

    ThingDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          -
            AttributeName: uuid
            AttributeType: S
        KeySchema:
          -
            AttributeName: uuid
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.thingName}

    LocationDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          -
            AttributeName: uuid
            AttributeType: S
          -
            AttributeName: location
            AttributeType: S
        KeySchema:
          -
            AttributeName: uuid
            KeyType: HASH
        GlobalSecondaryIndexes:
          -
            IndexName: "contents"
            KeySchema:
              -
                AttributeName: location
                KeyType: HASH
              -
                AttributeName: uuid
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.locationName}

    LandDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          -
            AttributeName: uuid
            AttributeType: S
          -
            AttributeName: location
            AttributeType: S
          -
            AttributeName: coordinates
            AttributeType: S
        KeySchema:
          -
            AttributeName: uuid
            KeyType: HASH
        GlobalSecondaryIndexes:
          -
            IndexName: "contents"
            KeySchema:
              -
                AttributeName: location
                KeyType: HASH
              -
                AttributeName: uuid
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
          -
            IndexName: "cartesian"
            KeySchema:
              -
                AttributeName: coordinates
                KeyType: HASH
              -
                AttributeName: uuid
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.landName}

    SuggestionDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: uuid
            AttributeType: S
        KeySchema:
          - AttributeName: uuid
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:custom.tables.suggestionName}

  Outputs:
    ThingTopic:
      Value: !Ref ThingTopic
      Export:
        Name: ${self:provider.stage}-ThingTopic