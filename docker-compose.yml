version: '3.8'

services:
  localstack:
    image: localstack/localstack:latest
    container_name: serverless-game-localstack
    ports:
      - "4566:4566"            # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - DEBUG=1
      - LAMBDA_EXECUTOR=docker-reuse
      - LAMBDA_REMOTE_DOCKER=false
      - LAMBDA_REMOVE_CONTAINERS=true
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=ap-southeast-1
      - SERVICES=dynamodb,sns,lambda,stepfunctions,iam,logs,events,apigateway
      - LS_LOG=warn
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./.localstack}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init-aws.sh"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - localstack-network

  game-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: serverless-game-server
    ports:
      - "8000:8000"
    environment:
      - LOCALSTACK_ENDPOINT=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=ap-southeast-1
      - THING_TABLE=thing-table-local
      - LOCATION_TABLE=location-table-local
      - LAND_TABLE=land-table-local
      - SUGGESTION_TABLE=suggestion-table-local
      - USERS_TABLE=users-local
      - API_KEYS_TABLE=api-keys-local
      - JWT_SECRET=dev-secret-key
      - STAGE=local
      - DD_TRACE_ENABLED=false
      - THING_TOPIC_ARN=arn:aws:sns:ap-southeast-1:000000000000:thing-topic-local
      - MESSAGE_DELAYER_ARN=arn:aws:states:ap-southeast-1:000000000000:stateMachine:message-delayer-local
      - HOST=0.0.0.0
      - PORT=8000
    volumes:
      - ./backend:/app/backend
      - ./scripts:/app/scripts
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - localstack-network

  # Optional: Simple web UI for LocalStack resources
  localstack-web:
    image: localstack/localstack:latest
    container_name: serverless-game-localstack-web
    ports:
      - "8080:8080"
    environment:
      - LOCALSTACK_WEB_UI=1
    networks:
      - localstack-network
    profiles:
      - web

networks:
  localstack-network:
    driver: bridge
